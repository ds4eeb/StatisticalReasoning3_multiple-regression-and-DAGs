---
title: "Activity 11: Statistical reasoning 3: multiple regression and DAGs"
subtitle: Feb. 11th, 2026, Calvin Munson
format: gfm
execute:
  warning: false
editor: source
---

Welcome! This is the third statistical reasoning activity. The goals of this activity are to understand how to implement DAGs in the context of multiple regression.

------------------------------------------------------------------------

You will submit one output for this activity:

1.  A **PDF** of a rendered Quarto document with all of your R code. Please create a new Quarto document (e.g. don't use this `README.qmd`), include all of the code that appears in this document, in addition to adding your own code and **answers to all of the questions** in the "Q#" sections. Submit this through Gradescope.

*If you have trouble submitting as a PDF, please ask Calvin or Malin for help. If we still can't solve it, you can submit the .qmd file instead.*

A reminder: **Please label the code** in your final submission in two ways: 

1. denote your answers to each question using headers that correspond to the question you're answering, and 
2. thoroughly "comment" your code: remember, this means annotating your code directly by typing descriptions of what each line does after a `#`. This will help future you!

------------------------------------------------------------------------

Let's start by reading in the relevant packages

```{r}
# Run this to install some data packages
# devtools::install_github("rmcelreath/rethinking")
library(rethinking)

library(brms) # for statistics
library(tidyverse) # for data wrangling
# install.packages("dagitty_0.3-4.tgz", repos = NULL, type = "source")
# library("daggity")

```


# DAG practice
![example DAG](example_DAG.jpg)

Directed Acyclic Graphs (DAGs) represent our understanding of causal influences in a system, with arrows connecting causes to effects. Consider the DAG above and modify it to include the variable V, an unobserved cause of C and Y: C ← V → Y. Reanalyze the DAG. How many paths connect X to Y? Which must be closed? Which variables should you condition on now?

identify the fundamental parts

-----------





------

# Foxes: Regression practice informed by DAGs

```{r}
# Load in the fox data
data(foxes)

# Check out the fox data
?foxes
head(foxes)
```

"All three problems below are based on the same data. The data in data(foxes) are 116 foxes from 30 different urban groups in England. These foxes are like street gangs. Group size varies from 2 to 8 individuals. Each group maintains its own urban territory. Some territories are larger than others. The area variable encodes this information. Some territories also have more avgfood than others. We want to model the weight of each fox. For the problems below, assume the following DAG:"

![fox DAG](foxDAG.jpg)

---------

6H3.  Use a model to infer the total causal influence of area on weight. Would increasing the area available to each fox make it heavier (healthier)? You might want to standardize the variables. Regardless, use prior predictive simulation to show that your model’s prior predictions stay within the possible outcome range.

### Solution to 6H3
Standardize weight to mean zero and standard deviation of 1

```{r}
fox_dat <- foxes %>%
  as_tibble() %>%
  select(area, avgfood, weight, groupsize) %>%
  mutate(across(everything(), standardize))
```

Simulate from some priors for a linear regression: alpha ~ Gaussian(0, 0.2), beta ~ Gaussian(0, 0.5)

```{r}
n <- 1000
priorsims <- tibble(group = seq_len(n),
       alpha = rnorm(n, 0, 0.2), # prior for alpha
       beta = rnorm(n, 0, 0.5)) %>% # prior for beta
  expand(nesting(group, alpha, beta),
         area = seq(from = -2, to = 2, length.out = 100)) %>% # set up a range of areas
  mutate(weight = alpha + beta * area) # calculate weight from parameters and area
```

Make a plot of what these priors imply
```{r}
minweight_std <- (0 - mean(foxes$weight)) / sd(foxes$weight) # a fox of zero weight, standardized to match the data
maxweight_std <- (max(foxes$weight) - mean(foxes$weight)) / sd(foxes$weight) # max fox weight, standardized to match the data

ggplot(priorsims, aes(x = area, y = weight, group = group)) +
  geom_line(alpha = 1 / 10) +
  geom_hline(yintercept = c(minweight_std,
                            maxweight_std),
             linetype = c("dashed", "solid"), color = "red") +
  annotate(geom = "text", x = -2, y = -3.83, hjust = 0, vjust = 1,
           label = "No weight") +
  annotate(geom = "text", x = -2, y = 2.55, hjust = 0, vjust = 0,
           label = "Maximum weight") +
  expand_limits(y = c(-4, 4)) +
  labs(x = "Standardized Area", y = "Standardized Weight")

```

Run a model predicting average food as a function of area

```{r}
food_on_area <- brm(avgfood ~ 1 + area, data = fox_dat, family = gaussian,
                    prior = c(prior(normal(0, 0.2), class = Intercept),
                              prior(normal(0, 0.5), class = b,),
                              prior(exponential(1), class = sigma)),
                    iter = 4000, warmup = 2000, chains = 4, cores = 4, seed = 1234,
                    file = "output/food_on_area")

summary(food_on_area)
```

We see a fairly strong effect of area on the average amount of food; because we standardized the data by standard deviations, we find that for an increase of 1 standard deviation in area we would expect to see a .88 standard deviation increase in food. The credible interval for area is 0.79 to 0.96, which does not include zero. Logically this makes sense, as a greater area means there are would be more prey available.


-------------

6H4.  Now infer the causal impact of adding food to a territory. Would this make foxes heavier? Which covariates do you need to adjust for to estimate the total causal influence of food?



```{r}
food_total <- brm(weight ~ 1 + avgfood, data = fox_dat, family = gaussian,
                  prior = c(prior(normal(0, 0.2), class = Intercept),
                            prior(normal(0, 0.5), class = b,),
                            prior(exponential(1), class = sigma)),
                  iter = 4000, warmup = 2000, chains = 4, cores = 4, seed = 1234,
                  file = "output/food_total")

summary(food_total)
```

First the total effect. In this model we see basically no effect of food on weight. The 95% interval in the {brms} output is -0.21 to 0.15 with a mean of -0.02.

Now we estimate the direct effect, adding in `groupsize`:

```{r}
food_direct <- brm(weight ~ 1 + avgfood + groupsize, data = fox_dat,
                   family = gaussian,
                   prior = c(prior(normal(0, 0.2), class = Intercept),
                             prior(normal(0, 0.5), class = b,),
                             prior(exponential(1), class = sigma)),
                   iter = 4000, warmup = 2000, chains = 4, cores = 4, seed = 1234,
                   file = "output/food_direct")

summary(food_direct)
```

Here we see that when we stratify by group size, we see a strong positive effect of food on weight. This indicates that within a given group size, more food is associated with more weight (heavier foxes). We also see a negative effect of group size: as the group size increases, the weight of individual foxes declines.

Altogether, these results seem to suggest a masking effect, where one variable is cancelling out the effect of another. That is, as more food is available, more foxes move into the territory, increasing the group size. This continues until an equilibrium is reached where the amount of food available is equally good (or equally bad) within each territory. Thus, the total effect of food is negligible because as more food becomes available, the group size increases such that the amount of food available for each individual fox remains relatively stable.

--------------

6H5.  Now infer the causal impact of group size. Which covariates do you need to adjust for? Looking at the posterior distribution of the resulting model, what do you think explains these data? That is, can you explain the estimates for all three problems? How do they go together?



Next we estimate the direct effect. Here we see that when we stratify by group size, we see a strong positive effect of food on weight. This indicates that within a given group size, more food is associated with more weight.


--------



---------------

### Render to PDF

When you have finished, remember to pull, stage, commit, and push with GitHub:

-   Pull to check for updates to the remote branch
-   Stage your edits (after saving your document!) by checking the documents you'd like to push
-   Commit your changes with a commit message
-   Push your changes to the remote branch

Then submit the well-labeled PDF on Gradescope. Thanks!
