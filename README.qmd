---
title: "Activity 11: Statistical reasoning 3: multiple regression and DAGs"
subtitle: Feb. 11th, 2026, Calvin Munson
format: gfm
execute:
  warning: false
editor: source
---

Welcome! This is the third statistical reasoning activity. The goals of this activity are to understand how to implement DAGs in the context of multiple regression. Specifically, you will:

1.    Build and interpret the relationships in DAGs
2.    Use prior predictive simulation to adjust priors
3.    Apply your undertanding of DAG structure to a multiple regression problem

------------------------------------------------------------------------

You will submit one output for this activity:

1.  A **PDF** of a rendered Quarto document with all of your R code. Please create a new Quarto document (e.g. don't use this `README.qmd`), include all of the code that appears in this document, in addition to adding your own code and **answers to all of the questions** in the "Q#" sections. Submit this through Gradescope.

*If you have trouble submitting as a PDF, please ask Calvin or Malin for help. If we still can't solve it, you can submit the .qmd file instead.*

A reminder: **Please label the code** in your final submission in two ways: 

1. denote your answers to each question using headers that correspond to the question you're answering, and 
2. thoroughly "comment" your code: remember, this means annotating your code directly by typing descriptions of what each line does after a `#`. This will help future you!

------------------------------------------------------------------------

Let's start by reading in the relevant packages

```{r}
# Run this to install some data packages
# devtools::install_github("rmcelreath/rethinking")
library(rethinking)

library(brms) # for statistics
library(tidyverse) # for data wrangling
# install.packages("dagitty_0.3-4.tgz", repos = NULL, type = "source")
# library("daggity")

```


# 1. DAG practice
![example DAG](example_DAG.jpg)

Directed Acyclic Graphs (DAGs) represent our understanding of causal influences in a system, with arrows connecting causes to effects. Consider the DAG above. 

Now recreate the DAG above on [dagitty.net](https://dagitty.net). Leave the window open, as we'll be using it more.

### Q1.1
Please paste either your DAG image from the website or the DAG model code here.

-----------
There are four fundamental relations in a DAG: the fork, the pipe, the collider, and the descendent.
![elemental confounds](elemental_confounds.jpg)

### Q1.2
Which forks do you see? Please write them out in a Quarto list (look up how to do this if you don't remember!) in the form L ← M → N.

-----------
### Q1.3
Which colliders do you see? Please write them out in a Quarto list in the form L → M ← N. Hint: there is more than one!

-----------
### Q1.4
Now modify the DAG (should still be on dagitty.net) to include the variable V, an unobserved cause of C and Y: C ← V → Y. Please paste either your DAG image from the website or the DAG model code here.

-----------
### Q1.5
Reanalyze this new DAG. How many paths connect X to Y? Please list them in a Quarto list here:

-----------
### Q1.6
Which paths must be closed to estimate the direct effect of X on Y? 

-----------
### Q1.7
Given what you just wrote about paths to close, which variables should you condition on to estimate the direct effect of X on Y in your new DAG?


-----------





------

# 2. Foxes: Regression practice informed by DAGs

For this section, we are going to implement what we learned about DAGs into an example about foxes from the `rethinking` package. Let's load in the data:

```{r}
# Load in the fox data
data(foxes)
```


```{r}
# Check out the fox data
?foxes
head(foxes)
```

From the Rethinking textbook: "The data in data(foxes) are 116 foxes from 30 different urban groups in England. These foxes are like street gangs. `Group size` varies from 2 to 8 individuals. Each group maintains its own urban territory. Some territories are larger than others. The `area` variable encodes this information. Some territories also have more `avgfood` than others. We want to model the `weight` of each fox (in kg). For the problems below, assume the following DAG:"

![fox DAG](foxDAG.jpg)

---------

### Q2.1 Identify the "elemental confounds" in the fox DAG

Which of the confounds below (Fork, Pipe, Collider, and Descendant) do you see in the Fox DAG? List the names of the confounds you see AND the particular paths (e.g. "Pipe1: X->Z->Y, Pipe2: X->Z->C and Fork1: X<-Z->Y")

*Answer:*
Pipe 1: area -> avgfood -> weight
Pipe 2: area -> avgfood -> groupsize -> weight
Fork 1: weight <- avgfood -> groupsize 
Collider 1: avgfood -> weight <- groupsize

![elemental confounds](elemental_confounds.jpg)


--------

### Total causal influence of area on weight

In this first part we are going to infer the total causal influence of area on weight. Would increasing the area available to each fox make it heavier (healthier)? 

-   First we will standardize the variables. 
-   Second we will use prior predictive simulation to show that your model’s prior predictions stay within the possible outcome range.
-   Third we will run the models

#### Standardize

Standardize weight to mean zero and standard deviation of 1

```{r}
fox_dat <- foxes %>%
  as_tibble() %>%
  select(area, avgfood, weight, groupsize) %>%
  mutate(across(everything(), standardize))
```

Simulate from some priors for a linear regression with intercept alpha and slope beta: alpha ~ Gaussian(0, 0.2), beta ~ Gaussian(0, 2)

```{r}
n <- 1000
priorsims <- tibble(group = seq_len(n),
       alpha = rnorm(n, 0, 0.2), # prior for alpha
       beta = rnorm(n, 0, 2)) %>% # prior for beta
  expand(nesting(group, alpha, beta), # the expand function gives us all possible combinations of the arguments
         area = seq(from = -2, to = 2, length.out = 100)) %>% # set up a range of areas
  mutate(weight = alpha + beta * area) # calculate weight from the parameters and area
```

Make a plot of what these priors imply.
```{r}
ggplot(priorsims, aes(x = area, y = weight, group = group)) +
  geom_line(alpha = 1 / 10) +
  labs(x = "Standardized Area", y = "Standardized Weight")

```
It's pretty hard to understand what a "reasonable" fox weight is when it is in standardized units. 

--------------------
### Q2.A 
What to you seems like a reasonable minimum weight for a fox, in kg?

*Answer*
Something in 7 to 15 kg makes sense. No need to be too strict.


--------------------
### Q2.B 
What to you seems like a reasonable minimum weight for a fox, in kg?

*Answer*
Something in 0 to 3 kg makes sense. No need to be too strict.

--------------------
### Q2.C
Remake your prior predictive simulation plot and add two horizontal lines, one each for the minimum and maximum weights that you just provided. Before plotting, make sure to *standardize* your values in kg so that they are plotted as centered values in units of standard deviation (i.e., subtract the mean and divide by the standard deviation of foxes$weight).

*Answer*
```{r}
minweight_std <- (0 - mean(foxes$weight)) / sd(foxes$weight) # a fox of zero weight, standardized to match the data
maxweight_std <- (14 - mean(foxes$weight)) / sd(foxes$weight) # max fox weight, standardized to match the data

ggplot(priorsims, aes(x = area, y = weight, group = group)) +
  geom_line(alpha = 1 / 10) +
  geom_hline(yintercept = c(minweight_std,
                            maxweight_std),
             linetype = c("dashed", "solid"), color = "red") +
  expand_limits(y = c(-4, 4)) +
  labs(x = "Standardized Area", y = "Standardized Weight")

```


----------------

### Q2.D
Do your priors seem reasonable? You haven't seen any data yet, though you have marked out the minimum and maximum weights you expect foxes to be. Do your priors greatly exceed those values? Please explain your thinking.

*Answer*
The priors do not seem reasonable. They imply negative weights for foxes in large or small areas.

--------------------
### Q2.E
Remake and plot a set of prior simulations that use priors you think are reasonable (adjusting the code from above would work well for this). Be sure to include the minimum and maximum fox weights that you expect. You can iterate on this a few times until you arrive at priors that make sense to you.

*Answer*
They should have code and a plot with few or no lines exceeding their min and max lines. Something like alpha ~ Gaussian(0, 0.2), beta ~ Gaussian(0, 0.5) would make sense, but we can accept a wide range here.

---------

Run a model predicting average food as a function of area

```{r}
food_on_area <- brm(avgfood ~ 1 + area, 
                    data = fox_dat, 
                    family = gaussian,
                    # Here we set the priors that we investigated earlier
                    prior = c(prior(normal(0, 0.2), class = Intercept),
                              prior(normal(0, 0.5), class = b,),
                              prior(exponential(1), class = sigma)),
                    iter = 4000, warmup = 2000, chains = 4, cores = 4, seed = 1234,
                    file = "output/food_on_area")
```

Now let's check out the summary

```{r}
summary(food_on_area)
```

We see a fairly strong effect of area on the average amount of food; because we standardized each variable by standard deviations, our units are now in "standard deviations". (*We can backtransform these value to translate this back to the normal units! We won't do that here, as we'll get a lot more practice with that when we get to generalized linear models, but just know that if you are annoyed by the unitless values, there's a way out!*)

We find that for an increase of 1 standard deviation in area we would expect to see a .88 standard deviation increase in food. The credible interval for area is 0.79 to 0.96, which does not include zero. Logically this makes sense, as a greater area means there are would be more prey available.

-------------

### Q2.2a Run a model to look at the impact of food on fox weight 

Now infer the causal impact of adding food to a territory. Run a model with `weight` as a function of `avgfood`. Do you think this make foxes heavier? Interpret your results and whether or not the amount of food increases fox weight according to this model. Is this expected or unexpected?


```{r}
food_total <- brm(weight ~ 1 + avgfood, data = fox_dat, family = gaussian,
                  prior = c(prior(normal(0, 0.2), class = Intercept),
                            prior(normal(0, 0.5), class = b,),
                            prior(exponential(1), class = sigma)),
                  iter = 4000, warmup = 2000, chains = 4, cores = 4, seed = 1234,
                  file = "output/food_total")

summary(food_total)
```



-------------

### Q2.2b Is there a variable we should condition upon?

Think back to your DAG elemental confounds. Is there a variable that we should condition upon that may be affecting our results?

*Yes; we should condition upon group size because of the path from avgfood -> grpsize -> weight, in addition to avgfood -> weight*


--------------

### Add in `groupsize`

In the previous model we saw basically no effect of `avgfood` on `weight`, but we have an extra path that we need to account for, since `avgfood` flows to `weight` through `groupsize`.

First, let's look at the separate effect of `groupsize` in a univariate regression, just like with `avgfood`:

```{r}
group_on_weight <- brm(weight ~ 1 + groupsize, 
                       data = fox_dat, 
                       family = gaussian,
                       prior = c(prior(normal(0, 0.2), class = Intercept),
                                 prior(normal(0, 0.5), class = b,),
                                 prior(exponential(1), class = sigma)),
                       iter = 4000, warmup = 2000, chains = 4, cores = 4, seed = 1234,
                       file = "output/group_on_weight")
```


```{r}
summary(group_on_weight)
```

Similar to the sole effect of `avgfood` in a univariate regression, we see no effect; the estimate for the slope of `groupsize` on `weight` is -0.16, but the 95% CI are between -0.33 and 0.02, which includes 0, meaning the effect of group size could very well be zero *given this model*

Now, let's combine both of these variables - `avgfood` and `groupsize` - into a multiple regression to solve our path problem and estimate the **direct effect** of `avgfood` on `weight`. (This will also give us the direct effect of `groupsize` on `weight`).

Now we add in `groupsize`. This accounts for the fork/pipe between `weight`->`groupsize`->`avgfood`.

```{r}
food_direct <- brm(weight ~ 1 + avgfood + groupsize, data = fox_dat,
                   family = gaussian,
                   prior = c(prior(normal(0, 0.2), class = Intercept),
                             prior(normal(0, 0.5), class = b,),
                             prior(exponential(1), class = sigma)),
                   iter = 4000, warmup = 2000, chains = 4, cores = 4, seed = 1234,
                   file = "output/food_direct")

summary(food_direct)
```

### Q2.3 Interpret the multiple regression output

Interpret the output of this model which looks at `weight ~ avgfood + groupsize`. 

1.    What are the effects of `avgfood` and `groupsize` now that you have accounted for both variables?
2.    How does this change your interpretation from the univariate regressions of each variable separately?
3.    Provide a small discussion (2-4 sentences) of why you think these results turned out the way they did in the context of the ecological system of fox territories. Include why you think that the univariate regressions may have come out as un-informative.

Some answers:

Here we see that when we stratify by group size, we see a strong positive effect of food on weight. This indicates that within a given group size, more food is associated with more weight (heavier foxes). We also see a negative effect of group size: as the group size increases, the weight of individual foxes declines.

Altogether, these results seem to suggest a masking effect, where one variable is cancelling out the effect of another. That is, as more food is available, more foxes move into the territory, increasing the group size. This continues until an equilibrium is reached where the amount of food available is equally good (or equally bad) within each territory. Thus, the total effect of food is negligible because as more food becomes available, the group size increases such that the amount of food available for each individual fox remains relatively stable.


--------



---------------

### Render to PDF

When you have finished, remember to pull, stage, commit, and push with GitHub:

-   Pull to check for updates to the remote branch
-   Stage your edits (after saving your document!) by checking the documents you'd like to push
-   Commit your changes with a commit message
-   Push your changes to the remote branch

Then submit the well-labeled PDF on Gradescope. Thanks!
